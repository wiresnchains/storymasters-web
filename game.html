<!DOCTYPE html>
<html lang="een">

<head>
    <meta charset="utf-8" />
    <meta params.name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storymasters - Game</title>
    <link rel="stylesheet" href="/style/style.css">
</head>

<body>
    <a class="back-home" href="/">Terug naar home</a>
    <div class="banner" id="theme">
        <h1 id="theme-value">Hier komt thema</h1>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="player-list">
        <div class="card players flex flex-wrap g-2" id="list"></div>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="user-story-input">
        <div class="card game flex vertical g-1">
            <div id="game" class="card game flex horizontal g-1">
                <input class="textbox w-100 text-center" type="text" value="Als" id="gameText1" disabled readonly />
                <input class="textbox w-100 text-center" type="text" params.name="as" placeholder="Vul in" id="input1" />
                <input class="textbox w-100 text-center" type="text" value="wil ik" id="gameText2" disabled readonly />
                <input class="textbox w-100 text-center" type="text" params.name="wantTo" placeholder="Vul in" id="input2" />
                <input class="textbox w-100 text-center" type="text" value="zodat" id="gameText3" disabled readonly />
                <input class="textbox w-100 text-center" type="text" params.name="soThat" placeholder="Vul in" id="input3" />
            </div>
            <div style="display: none;" id="submit-text" class="card game flex horizontal g-1">
                <input class="textbox w-100 text-center" type="text" id="submit-input" disabled readonly />
            </div>
            <button id="submit" class="btn btn-primary">Submit</button>
        </div>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="voting">
        voting
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="leaderboard">
        leaderboard
    </div>

    <p id="timer">00:00</p>

    <script src="/script/script.js" type="text/javascript"></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", start);


        // (() => {
        function start() {
            document.querySelector('button#submit').addEventListener('click', submitBtn);

            const params = Object.fromEntries(new URLSearchParams(window.location.search).entries());

            if (!params.connectionCode || !params.name) {
                window.location.replace("/");
                return;
            }
 
            const game = connectToGame(params.name, params.connectionCode);
            // game.sendEvent('send-user-story', { message: 'instant websocket test msg' });
            const theme = document.getElementById("theme");
            const playerList = document.getElementById("player-list");
            const userStoryInput = document.getElementById("user-story-input");
            const voting = document.getElementById("voting");
            const leaderboard = document.getElementById("leaderboard");
            const timer = document.getElementById("timer");
            
            function switchView(view) {
                theme.style.display = "none";
                playerList.style.display = "none";
                userStoryInput.style.display = "none";
                voting.style.display = "none";
                leaderboard.style.display = "none";
                timer.style.display = "none";

                switch (view) {
                    case "player-list":
                        playerList.style.display = "";
                        break;
                    case "user-story-input":
                        theme.style.display = "";
                        userStoryInput.style.display = "";
                        timer.style.display = "";
                        break;
                    case "voting":
                        theme.style.display = "";
                        voting.style.display = "";
                        timer.style.display = "";
                        break;
                    case "leaderboard":
                        leaderboard.style.display = "";
                        timer.style.display = "";
                        break;
                }
            }

            function setTheme(theme) {
                document.getElementById("theme-value").innerHTML = theme;
            }

            switchView("player-list");
            setTheme("Unknown theme");

            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
            }

            let timerInterval;

            function startCountdown(seconds) {
                if (timerInterval) {
                    clearInterval(timerInterval);
                }

                timerInterval = setInterval(() => {
                    if (seconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = undefined;
                        return;
                    }

                    seconds--;

                    timer.innerHTML  = formatTime(seconds);
                }, 1000);
            }

            game.addEvent("player-joined", (name) => {
                console.log("player " + name + " joined");
                const list = playerList.querySelector("#list");
                list.style.display = 'none';
                list.parentElement.innerHTML += `<div class="card player flex center-x center-y" id="player-${params.name}"><p class="btn" id="naam">${params.name}</p></div>`;
            });

            game.addEvent("player-removed", (name) => {
                console.log("player " + name + " left");
                document.getElementById(`player-${name}`).remove();
            });

            game.addEvent("start-round", (theme) => {
                switchView("user-story-input");
                setTheme(theme);
                startCountdown(60);
            });

            game.addEvent("show-voting", (payload) => {
                switchView("voting");

                if (payload.showResults) {
                    startCountdown(5);
                }
                else {
                    startCountdown(10);
                }
            });

            game.addEvent("show-leaderboard", (payload) => {
                switchView("leaderboard");
                startCountdown(5);
            });


            function submitBtn() {
                const elements = {
                    game: document.getElementById("game"),
                    submitText: document.getElementById("submit-text"),
                    submitBtn: document.getElementById("submit"),
                    submitInput: document.getElementById("submit-input"),
                };

                const texts = [
                    "Antwoord verstuurd!",
                    "Even nadenkenâ€¦ ðŸ¤”",
                    "Dit ging snel!",
                    "Goede keuze!",
                    "Succes! ðŸ€",
                    "Wachten op de restâ€¦",
                    "Bijna daar!",
                    "Topantwoord! â­",
                    "Ingezonden ðŸš€",
                    "Slim gespeeld!",
                ];

                // Kies een random tekst
                const randomText = texts[Math.floor(Math.random() * texts.length)];

                elements.submitInput.value = randomText;
                elements.submitBtn.style.display = 'none';
                elements.game.style.display = 'none';
                elements.submitText.style.display = 'inline-flex';

                const nodeList = elements.game.querySelectorAll('input');
                const input = [...nodeList].map(input => input.value);
                const userStory = input.join(' ');

                game.sendEvent('send-user-story', { message: userStory });
            }
        }
        // })();

    </script>
</body>

</html>