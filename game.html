<!DOCTYPE html>
<html lang="een">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storymasters - Game</title>
    <link rel="stylesheet" href="/style/style.css">
</head>

<body>
    <a class="back-home" href="/">Terug naar home</a>
    <div class="banner" id="theme">
        <h1 id="theme-value" style="font-size: 1.5rem;">Hier komt thema</h1>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="player-list">
        <div class="card players flex flex-wrap g-2" id="list"></div>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="user-story-input">
        <div class="card game flex vertical g-1">
            <div id="game" class="card game flex horizontal g-1">
                <input class="textbox w-100 text-center" type="text" value="Als" id="gameText1" disabled readonly />
                <input class="textbox w-100 text-center" type="text" name="as" placeholder="Vul in" id="input1" />
                <input class="textbox w-100 text-center" type="text" value="wil ik" id="gameText2" disabled readonly />
                <input class="textbox w-100 text-center" type="text" name="wantTo" placeholder="Vul in" id="input2" />
                <input class="textbox w-100 text-center" type="text" value="zodat" id="gameText3" disabled readonly />
                <input class="textbox w-100 text-center" type="text" name="soThat" placeholder="Vul in" id="input3" />
            </div>
            <div style="display: none;" id="submit-text" class="card game flex horizontal g-1">
                <input class="textbox w-100 text-center" type="text" id="submit-input" disabled readonly />
            </div>
            <button onclick="submitBtn()" id="submit" class="btn btn-primary">Submit</button>
        </div>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="voting">
        <div class="card vote flex vertical g-1">
            <div class="voteOptions">
                <table class="w-100" id="votes">
                    <tr class="horizontal">
                        <th class="flex">Naam</th>
                        <th>User Story</th>
                        <th class="flex">Vote</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="page-wrapper flex center-x center-y h-100" id="leaderboard">
        <div class="card leaderBoard flex vertical g-1">
            <div class="flex vertical">
                <table id="leaderboard-table">
                    <tr>
                        <th class="">Naam</th>
                        <th class="">Aantal punten</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <p id="timer">00:00</p>

    <script src="/script/script.js" type="text/javascript"></script>
    <script type="text/javascript">
        let submitBtn;
        let voteBtn;

        (() => {
            const params = new URLSearchParams(window.location.search);
            const connectionCode = params.get("connectionCode");
            const name = params.get("name");

            if (!connectionCode || !name) {
                window.location.replace("/");
                return;
            }

            const game = connectToGame(name, connectionCode);
            const theme = document.getElementById("theme");
            const playerList = document.getElementById("player-list");
            const userStoryInput = document.getElementById("user-story-input");
            const voting = document.getElementById("voting");
            const leaderboard = document.getElementById("leaderboard");
            const timer = document.getElementById("timer");
            const votes = document.getElementById("votes");
            const leaderboardTable = document.getElementById("leaderboard-table");
            
            function switchView(view) {
                theme.style.display = "none";
                playerList.style.display = "none";
                userStoryInput.style.display = "none";
                voting.style.display = "none";
                leaderboard.style.display = "none";
                timer.style.display = "none";

                switch (view) {
                    case "player-list":
                        playerList.style.display = "";
                        break;
                    case "user-story-input":
                        theme.style.display = "";
                        userStoryInput.style.display = "";
                        timer.style.display = "";
                        break;
                    case "voting":
                        theme.style.display = "";
                        voting.style.display = "";
                        timer.style.display = "";
                        break;
                    case "leaderboard":
                        leaderboard.style.display = "";
                        timer.style.display = "";
                        break;
                }
            }

            function setTheme(theme) {
                document.getElementById("theme-value").innerHTML = theme;
            }

            switchView("player-list");
            setTheme("Unknown theme");

            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
            }

            let timerInterval;

            function startCountdown(seconds) {
                if (timerInterval) {
                    clearInterval(timerInterval);
                }

                timerInterval = setInterval(() => {
                    if (seconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = undefined;
                        return;
                    }

                    seconds--;

                    timer.innerHTML  = formatTime(seconds);
                }, 1000);
            }

            function toggleUserStorySent(sent) {
                const game = document.getElementById("game");
                const submitText = document.getElementById("submit-text");
                const submitBtn = document.getElementById("submit");
                const submitInput = document.getElementById("submit-input");

                if (sent) {
                    const randomText = texts[Math.floor(Math.random() * texts.length)];

                    submitInput.value = randomText;

                    submitBtn.style.display = 'none';
                    game.style.display = 'none';
                    submitText.style.display = 'inline-flex';
                }
                else {
                    submitBtn.style.display = '';
                    game.style.display = '';
                    submitText.style.display = 'none';
                }
            }

            game.addEvent("player-joined", (name) => {
                console.log("player " + name + " joined");
                playerList.querySelector("#list").innerHTML += `<div class="card player flex center-x center-y" id="player-${name}"><p id="naam">${name}</p></div>`;
            });

            game.addEvent("player-removed", (name) => {
                console.log("player " + name + " left");
                document.getElementById(`player-${name}`).remove();
            });

            game.addEvent("start-round", (theme) => {
                toggleUserStorySent(false);
                switchView("user-story-input");
                setTheme(theme);
                startCountdown(60);
            });

            game.addEvent("show-voting", (payload) => {
                switchView("voting");

                if (payload.showResults) {
                    votes.innerHTML = `<tr class="horizontal">
                        <th class="flex">Naam</th>
                        <th>User Story</th>
                        <th class="flex">Votes</th>
                    </tr>`;
                    
                    payload.userStories.forEach(us => {
                        votes.innerHTML += `<tr>
                            <td><p class="naam">${us.owner.name}</p></td>
                            <td><p class="userStory">${us.story}</p></td>
                            <td>${us.votes}</td>
                        </tr>`;
                    });

                    startCountdown(10);
                }
                else {
                    votes.innerHTML = `<tr class="horizontal">
                        <th class="flex">Naam</th>
                        <th>User Story</th>
                        <th class="flex">Vote</th>
                    </tr>`;
                    
                    payload.userStories.forEach(us => {
                        let lastRow = `<td></td>`;

                        if (name !== us.owner.name) {
                            lastRow = `<td><button id="voteBtn" onclick="voteBtn(${us.index})">Vote</button></td>`;
                        }

                        votes.innerHTML += `<tr>
                            <td><p class="naam">${us.owner.name}</p></td>
                            <td><p class="userStory">${us.story}</p></td>
                            ${lastRow}
                        </tr>`;
                    });

                    startCountdown(10);
                }
            });

            game.addEvent("show-leaderboard", (payload) => {
                switchView("leaderboard");
                startCountdown(10);

                leaderboardTable.innerHTML = `<tr>
                        <th class="">Naam</th>
                        <th class="">Aantal punten</th>
                    </tr>`;

                payload.players.forEach(player => {
                    leaderboardTable.innerHTML += `<tr>
                        <td><p class="naam">${player.name}</p></td>
                        <td><p class="punten">${player.points}</p></td>
                    </tr>`;
                })
            });

            submitBtn = function() {
                const actor = document.getElementById("input1").value;
                const wantTo = document.getElementById("input2").value;
                const soThat = document.getElementById("input3").value;

                game.sendEvent("send-user-story", {
                    message: `Als ${actor} wil ik ${wantTo} zodat ${soThat}`
                });

                toggleUserStorySent(true);
            }

            voteBtn = function(index) {
                game.sendEvent("vote-for", {
                    userStoryIndex: index
                });

                document.querySelectorAll("#voteBtn").forEach(e => e.remove());
            }
        })();
    </script>
</body>

</html>